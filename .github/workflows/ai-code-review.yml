name: AI Code Review & Auto-Fix

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  ai-code-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Linting
        run: |
          pnpm lint || echo "Linting completed with warnings"

      - name: Run Type Check
        run: |
          pnpm typecheck || echo "Type check completed with warnings"

      - name: AI Code Analysis
        id: ai_analysis
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get changed files
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Save for next step
          echo "$CHANGED_FILES" > changed_files.txt

      - name: Generate Code Metrics
        run: |
          echo "ðŸ“Š Generating code metrics..."

          # Count lines of code
          TOTAL_LINES=$(find . -name '*.ts' -o -name '*.vue' -o -name '*.js' | xargs wc -l | tail -1 | awk '{print $1}')
          echo "Total lines: $TOTAL_LINES"

          # Count files
          TOTAL_FILES=$(find . -name '*.ts' -o -name '*.vue' -o -name '*.js' | wc -l)
          echo "Total files: $TOTAL_FILES"

          # Create metrics file
          cat > metrics.json <<EOF
          {
            "total_lines": $TOTAL_LINES,
            "total_files": $TOTAL_FILES,
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

      - name: Create Review Comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            let changedFiles = '';
            try {
              changedFiles = fs.readFileSync('changed_files.txt', 'utf8');
            } catch (e) {
              changedFiles = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„ÙØ§Øª Ù…ØªØºÙŠØ±Ø©';
            }

            let metrics = {};
            try {
              metrics = JSON.parse(fs.readFileSync('metrics.json', 'utf8'));
            } catch (e) {
              metrics = { total_lines: 0, total_files: 0 };
            }

            const reviewBody = `## ðŸ¤– ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¢Ù„ÙŠØ©

### ðŸ“Š Ø§Ù„Ù…Ù‚Ø§ÙŠÙŠØ³
- **Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø³Ø·Ø±**: ${metrics.total_lines}
- **Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù„ÙØ§Øª**: ${metrics.total_files}
- **Ø§Ù„ÙˆÙ‚Øª**: ${metrics.timestamp || new Date().toISOString()}

### ðŸ“ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØºÙŠØ±Ø©
\`\`\`
${changedFiles}
\`\`\`

### âœ… Ø§Ù„ØªÙˆØµÙŠØ§Øª
- ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØ¨Ø§Ø¹ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„ÙƒÙˆØ¯
- Ø±Ø§Ø¬Ø¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø£Ù…Ù†ÙŠØ©
- ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯

---
*ØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø¢Ù„ÙŠØ§Ù‹ Ø¨ÙˆØ§Ø³Ø·Ø© Ù†Ø¸Ø§Ù… WejdanAI*`;

            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: reviewBody
              });
            } catch (error) {
              console.log('Error creating comment:', error);
            }

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: code-review-artifacts
          path: |
            metrics.json
            changed_files.txt
          retention-days: 30
