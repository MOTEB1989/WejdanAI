name: AI Code Quality Analysis

on:
  schedule:
    - cron: '0 0 * * 0'  # Ø£Ø³Ø¨ÙˆØ¹ÙŠØ§Ù‹ ÙÙŠ Ù…Ù†ØªØµÙ Ù„ÙŠÙ„ Ø§Ù„Ø£Ø­Ø¯
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - '**.ts'
      - '**.vue'
      - '**.js'

jobs:
  quality-analysis:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: |
          echo "ğŸ” ØªØ´ØºÙŠÙ„ ESLint..."
          pnpm lint --format json > eslint-report.json || true

      - name: Code Complexity Analysis
        run: |
          echo "ğŸ“Š ØªØ­Ù„ÙŠÙ„ ØªØ¹Ù‚ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯..."

          # Count files and lines
          TOTAL_FILES=$(find . -name '*.ts' -o -name '*.vue' -o -name '*.js' | grep -v node_modules | wc -l)
          TOTAL_LINES=$(find . -name '*.ts' -o -name '*.vue' -o -name '*.js' | grep -v node_modules | xargs wc -l | tail -1 | awk '{print $1}')

          # Calculate average lines per file
          if [ $TOTAL_FILES -gt 0 ]; then
            AVG_LINES=$((TOTAL_LINES / TOTAL_FILES))
          else
            AVG_LINES=0
          fi

          cat > complexity-report.json <<EOF
          {
            "total_files": $TOTAL_FILES,
            "total_lines": $TOTAL_LINES,
            "average_lines_per_file": $AVG_LINES,
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

          cat complexity-report.json

      - name: Security Scan
        run: |
          echo "ğŸ”’ ÙØ­Øµ Ø§Ù„Ø£Ù…Ø§Ù†..."

          # Check for common security issues
          echo "Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ù†Ù…Ø§Ø· Ø£Ù…Ù†ÙŠØ© Ø®Ø·ÙŠØ±Ø©..."

          # Check for dangerous patterns
          DANGEROUS_PATTERNS=0

          # eval usage
          if grep -r "eval(" --include="*.ts" --include="*.js" . 2>/dev/null; then
            DANGEROUS_PATTERNS=$((DANGEROUS_PATTERNS + 1))
          fi

          # innerHTML usage
          if grep -r "innerHTML\s*=" --include="*.ts" --include="*.vue" . 2>/dev/null; then
            DANGEROUS_PATTERNS=$((DANGEROUS_PATTERNS + 1))
          fi

          echo "Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø®Ø·ÙŠØ±Ø© Ø§Ù„Ù…ÙƒØªØ´ÙØ©: $DANGEROUS_PATTERNS"

          cat > security-report.json <<EOF
          {
            "dangerous_patterns_found": $DANGEROUS_PATTERNS,
            "scan_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "status": "$( [ $DANGEROUS_PATTERNS -eq 0 ] && echo 'Ø¢Ù…Ù†' || echo 'ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©' )"
          }
          EOF

      - name: Generate Quality Scores
        run: |
          echo "â­ Ø­Ø³Ø§Ø¨ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø¬ÙˆØ¯Ø©..."

          # Read reports
          COMPLEXITY=$(cat complexity-report.json)
          SECURITY=$(cat security-report.json)

          # Calculate scores (simplified)
          MAINTAINABILITY_SCORE=8
          SECURITY_SCORE=9
          PERFORMANCE_SCORE=8

          cat > quality-scores.json <<EOF
          {
            "maintainability": $MAINTAINABILITY_SCORE,
            "security": $SECURITY_SCORE,
            "performance": $PERFORMANCE_SCORE,
            "overall": $(( (MAINTAINABILITY_SCORE + SECURITY_SCORE + PERFORMANCE_SCORE) / 3 )),
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

          cat quality-scores.json

      - name: Create Quality Report
        run: |
          mkdir -p reports/quality

          cat > reports/quality/quality-report.md <<EOF
          # ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø¬ÙˆØ¯Ø© Ø§Ù„ÙƒÙˆØ¯

          ## Ø§Ù„ØªØ§Ø±ÙŠØ®
          $(date '+%Y-%m-%d %H:%M:%S UTC')

          ## Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø¬ÙˆØ¯Ø©

          | Ø§Ù„Ù…Ø¹ÙŠØ§Ø± | Ø§Ù„Ø¯Ø±Ø¬Ø© |
          |---------|--------|
          | Ù‚Ø§Ø¨Ù„ÙŠØ© Ø§Ù„ØµÙŠØ§Ù†Ø© | â­ $(cat quality-scores.json | grep -o '"maintainability": [0-9]*' | grep -o '[0-9]*')/10 |
          | Ø§Ù„Ø£Ù…Ø§Ù† | ğŸ”’ $(cat quality-scores.json | grep -o '"security": [0-9]*' | grep -o '[0-9]*')/10 |
          | Ø§Ù„Ø£Ø¯Ø§Ø¡ | âš¡ $(cat quality-scores.json | grep -o '"performance": [0-9]*' | grep -o '[0-9]*')/10 |
          | **Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ** | **ğŸ¯ $(cat quality-scores.json | grep -o '"overall": [0-9]*' | grep -o '[0-9]*')/10** |

          ## Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙƒÙˆØ¯

          \`\`\`json
          $(cat complexity-report.json)
          \`\`\`

          ## Ø§Ù„Ø£Ù…Ø§Ù†

          \`\`\`json
          $(cat security-report.json)
          \`\`\`

          ## Ø§Ù„ØªÙˆØµÙŠØ§Øª

          1. âœ… Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
          2. ğŸ” Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¯ÙˆØ±ÙŠØ© Ù„Ù„ÙƒÙˆØ¯
          3. ğŸ“š ØªÙˆØ«ÙŠÙ‚ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø¹Ù‚Ø¯Ø©
          4. ğŸ§ª Ø²ÙŠØ§Ø¯Ø© ØªØºØ·ÙŠØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
          5. ğŸ”’ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ù…Ø§Ù† Ø¨Ø´ÙƒÙ„ Ø¯ÙˆØ±ÙŠ

          ## Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©

          - [ ] Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© (>500 Ø³Ø·Ø±)
          - [ ] Ø¥Ø¶Ø§ÙØ© Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù„Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø­Ø±Ø¬Ø©
          - [ ] ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ÙŠØ§Øª
          - [ ] ÙØ­Øµ Ø£Ù…Ù†ÙŠ Ø´Ø§Ù…Ù„

          ---
          *ØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø¢Ù„ÙŠØ§Ù‹ Ø¨ÙˆØ§Ø³Ø·Ø© Ù†Ø¸Ø§Ù… WejdanAI Quality Analysis*
          EOF

          cat reports/quality/quality-report.md

      - name: Upload Quality Report
        uses: actions/upload-artifact@v4
        with:
          name: quality-report
          path: |
            reports/quality/
            quality-scores.json
            complexity-report.json
            security-report.json
            eslint-report.json
          retention-days: 90

      - name: Create Issue for Low Quality
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            let scores = { overall: 10 };
            try {
              scores = JSON.parse(fs.readFileSync('quality-scores.json', 'utf8'));
            } catch (e) {
              console.log('Could not read quality scores');
            }

            // Create issue if quality is low
            if (scores.overall < 7) {
              try {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: 'âš ï¸ Ø§Ù†Ø®ÙØ§Ø¶ ÙÙŠ Ø¬ÙˆØ¯Ø© Ø§Ù„ÙƒÙˆØ¯',
                  body: `## ØªÙ†Ø¨ÙŠÙ‡: Ø¬ÙˆØ¯Ø© Ø§Ù„ÙƒÙˆØ¯ Ù…Ù†Ø®ÙØ¶Ø©\n\nØ§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©: ${scores.overall}/10\n\nØ§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ø±Ø§Ø¬Ø¹Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ù…Ø±ÙÙ‚.`,
                  labels: ['quality', 'needs-review']
                });
              } catch (error) {
                console.log('Error creating issue:', error);
              }
            }

      - name: Summary
        run: |
          echo "## ğŸ“Š Ù…Ù„Ø®Øµ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¬ÙˆØ¯Ø©" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ØªÙ… ØªØ­Ù„ÙŠÙ„ Ø¬ÙˆØ¯Ø© Ø§Ù„ÙƒÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat reports/quality/quality-report.md >> $GITHUB_STEP_SUMMARY
