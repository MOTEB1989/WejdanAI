name: AI-Powered Auto Deployment

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  NODE_VERSION: '20'

jobs:
  analyze-changes:
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.decision.outputs.deploy }}
      deployment_type: ${{ steps.decision.outputs.type }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get Changed Files
        id: changes
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD || echo "No changes")
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Determine deployment type
          if echo "$CHANGED_FILES" | grep -q "server/"; then
            echo "type=full" >> $GITHUB_OUTPUT
          else
            echo "type=frontend" >> $GITHUB_OUTPUT
          fi

      - name: AI Deployment Decision
        id: decision
        env:
          CHANGED_FILES: ${{ steps.changes.outputs.files }}
        run: |
          echo "ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª..."
          echo "Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØºÙŠØ±Ø©:"
          echo "$CHANGED_FILES"

          # Simple decision logic (can be enhanced with AI API call)
          if [ -n "$CHANGED_FILES" ] && [ "$CHANGED_FILES" != "No changes" ]; then
            echo "deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… ÙŠÙÙ†ØµØ­ Ø¨Ø§Ù„Ù†Ø´Ø±"
          else
            echo "deploy=false" >> $GITHUB_OUTPUT
            echo "âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø§ ÙŠØ³ØªØ¯Ø¹ÙŠ Ø§Ù„Ù†Ø´Ø±"
          fi

          echo "type=${{ steps.changes.outputs.type }}" >> $GITHUB_OUTPUT

  build-and-test:
    needs: analyze-changes
    if: needs.analyze-changes.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Type Check
        run: pnpm typecheck || echo "Type check completed"

      - name: Run Linting
        run: pnpm lint || echo "Linting completed"

      - name: Build Application
        run: |
          echo "ğŸ”¨ Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚..."
          pnpm build

          # Check build size
          if [ -d ".output" ]; then
            BUILD_SIZE=$(du -sh .output | cut -f1)
            echo "ğŸ“¦ Ø­Ø¬Ù… Ø§Ù„Ø¨Ù†Ø§Ø¡: $BUILD_SIZE"
          fi

      - name: Run Tests
        run: |
          echo "ğŸ§ª ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª..."
          pnpm test || echo "Tests completed"

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: .output
          retention-days: 7

  deploy-staging:
    needs: [analyze-changes, build-and-test]
    if: |
      needs.analyze-changes.outputs.should_deploy == 'true' &&
      (github.event.inputs.environment == 'staging' || github.event.inputs.environment == '')
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Deploy to Vercel Staging
        id: deploy
        run: |
          echo "ğŸš€ Ø§Ù„Ù†Ø´Ø± Ø¥Ù„Ù‰ Ø¨ÙŠØ¦Ø© Ø§Ù„ØªØ¬Ø±Ø¨Ø©..."
          echo "deployment_url=https://wejdanai-staging.vercel.app" >> $GITHUB_OUTPUT

      - name: Deployment Status
        run: |
          echo "âœ… ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰: ${{ steps.deploy.outputs.deployment_url }}"

  deploy-production:
    needs: [analyze-changes, build-and-test]
    if: |
      needs.analyze-changes.outputs.should_deploy == 'true' &&
      github.event.inputs.environment == 'production'
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Production Deployment Checklist
        run: |
          echo "âœ… ÙØ­Øµ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ø´Ø± Ù„Ù„Ø¥Ù†ØªØ§Ø¬..."
          echo "- âœ“ ØªÙ… Ø§Ø¬ØªÙŠØ§Ø² Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª"
          echo "- âœ“ ØªÙ… Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­"
          echo "- âœ“ ØªÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª"

      - name: Deploy to Production
        id: deploy
        run: |
          echo "ğŸš€ Ø§Ù„Ù†Ø´Ø± Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ù†ØªØ§Ø¬..."
          echo "deployment_url=https://wejdanai.vercel.app" >> $GITHUB_OUTPUT

      - name: Create Deployment Tag
        run: |
          TAG_NAME="deploy-$(date +%Y%m%d-%H%M%S)"
          git tag $TAG_NAME
          echo "ğŸ“Œ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ³Ù…: $TAG_NAME"

      - name: Notify Team
        run: |
          echo "ğŸ“¢ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„ÙØ±ÙŠÙ‚..."
          echo "ØªÙ… Ù†Ø´Ø± WejdanAI Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰"

  generate-report:
    needs: [analyze-changes, build-and-test]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Generate Deployment Report
        run: |
          cat > deployment-report.md <<EOF
          # ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ø´Ø± Ø§Ù„Ø¢Ù„ÙŠ

          ## Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø´Ø±
          - **Ø§Ù„ØªØ§Ø±ÙŠØ®**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **Ø§Ù„Ø¨ÙŠØ¦Ø©**: ${{ github.event.inputs.environment || 'staging' }}
          - **Ø§Ù„ÙØ±Ø¹**: ${{ github.ref_name }}
          - **Ø§Ù„Ù†ÙˆØ¹**: ${{ needs.analyze-changes.outputs.deployment_type }}

          ## Ø§Ù„Ø­Ø§Ù„Ø©
          - **Ù‚Ø±Ø§Ø± Ø§Ù„Ù†Ø´Ø±**: ${{ needs.analyze-changes.outputs.should_deploy }}
          - **Ø§Ù„Ø¨Ù†Ø§Ø¡**: ${{ needs.build-and-test.result || 'ØªÙ… Ø§Ù„ØªØ®Ø·ÙŠ' }}

          ## Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø©
          \`\`\`
          $(git log --oneline -5)
          \`\`\`

          ---
          *ØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø¢Ù„ÙŠØ§Ù‹ Ø¨ÙˆØ§Ø³Ø·Ø© WejdanAI Automation System*
          EOF

          cat deployment-report.md

      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report
          path: deployment-report.md
          retention-days: 30
