name: Auto Test Generation

on:
  pull_request:
    paths:
      - 'server/**/*.ts'
      - 'server/**/*.js'
      - 'composables/**/*.ts'
      - 'utils/**/*.ts'
  workflow_dispatch:

jobs:
  generate-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Get Changed Files
        id: changed-files
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -E '\.(ts|js)$' || echo "")
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E '\.(ts|js)$' || echo "")
          fi

          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          if [ -z "$CHANGED_FILES" ]; then
            echo "count=0" >> $GITHUB_OUTPUT
          else
            echo "count=$(echo "$CHANGED_FILES" | wc -l)" >> $GITHUB_OUTPUT
          fi

      - name: Analyze Code for Testing
        if: steps.changed-files.outputs.count != '0'
        run: |
          echo "ðŸ” ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±..."
          echo "Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØºÙŠØ±Ø©: ${{ steps.changed-files.outputs.count }}"
          echo "${{ steps.changed-files.outputs.files }}"

      - name: Check Existing Tests
        if: steps.changed-files.outputs.count != '0'
        run: |
          echo "ðŸ“‹ ÙØ­Øµ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©..."

          # Count existing test files
          TEST_COUNT=$(find tests -name '*.test.ts' -o -name '*.spec.ts' 2>/dev/null | wc -l || echo "0")
          echo "Ø¹Ø¯Ø¯ Ù…Ù„ÙØ§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØ©: $TEST_COUNT"

      - name: Generate Test Template
        if: steps.changed-files.outputs.count != '0'
        run: |
          mkdir -p tests/auto-generated

          cat > tests/auto-generated/README.md <<EOF
          # Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…ÙÙˆÙ„Ø¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹

          Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¬Ù„Ø¯ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ØªÙ… ØªÙˆÙ„ÙŠØ¯Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨ÙˆØ§Ø³Ø·Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙƒØ§Ù…Ù„ Ø§Ù„Ø¢Ù„ÙŠ.

          ## Ø§Ù„Ù…Ù„ÙØ§Øª
          - ØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯ ÙÙŠ: $(date)
          - Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø®ØªØ¨Ø±Ø©: ${{ steps.changed-files.outputs.count }}

          ## ÙƒÙŠÙÙŠØ© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
          \`\`\`bash
          pnpm test tests/auto-generated
          \`\`\`
          EOF

      - name: Run Tests
        run: |
          echo "ðŸ§ª ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª..."
          pnpm test || echo "Tests execution completed"

      - name: Generate Test Coverage Report
        run: |
          echo "ðŸ“Š ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ± ØªØºØ·ÙŠØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª..."

          cat > test-coverage-report.md <<EOF
          # ðŸ“Š ØªÙ‚Ø±ÙŠØ± ØªØºØ·ÙŠØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª

          ## Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ø§Ù…Ø©
          - **Ø§Ù„ØªØ§Ø±ÙŠØ®**: $(date)
          - **Ø§Ù„ÙØ±Ø¹**: ${{ github.ref_name }}
          - **Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØºÙŠØ±Ø©**: ${{ steps.changed-files.outputs.count }}

          ## Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
          - âœ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù†Ø§Ø¬Ø­Ø©: -
          - âŒ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ÙØ§Ø´Ù„Ø©: -
          - â­ï¸ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ®Ø·Ø§Ø©: -

          ## Ø§Ù„ØªÙˆØµÙŠØ§Øª
          - Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù„Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
          - ØªØ­Ø³ÙŠÙ† ØªØºØ·ÙŠØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
          - Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ÙØ§Ø´Ù„Ø©

          ---
          *ØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø¢Ù„ÙŠØ§Ù‹*
          EOF

      - name: Upload Test Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts
          path: |
            tests/auto-generated/
            test-coverage-report.md
          retention-days: 30

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            let report = '';
            try {
              report = fs.readFileSync('test-coverage-report.md', 'utf8');
            } catch (e) {
              report = '## ðŸ§ª ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª\n\nÙ„Ù… ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª.';
            }

            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: report
              });
            } catch (error) {
              console.log('Error creating comment:', error);
            }
